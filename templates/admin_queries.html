<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Queries - MSPVL College</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a56db;
            --secondary: #0e4c92;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --glass-bg: rgba(31, 41, 55, 0.6);
            --glass-border: rgba(75, 85, 99, 0.3);
            --bg-light: #1f2937;
        }

        * { font-family: 'Inter', sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh; 
            padding: 1.5rem 0;
        }

        /* ðŸ”§ COMPACT CONTAINER - HALF SIZE */
        .admin-container {
            max-width: 1400px;  /* Reduced from 1600px */
            margin: 0 auto; 
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: var(--shadow);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; 
            padding: 1.5rem 2rem;  /* Reduced padding */
            position: relative;
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));  /* Smaller cards */
            gap: 1rem;
        }

        .stats-card {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 1.25rem;  /* Reduced */
            text-align: center;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            background: rgba(255,255,255,0.3);
            box-shadow: var(--shadow-hover);
        }

        .stats-number {
            font-size: 2rem;  /* Reduced from 2.5rem */
            font-weight: 800;
            background: linear-gradient(135deg, white, rgba(255,255,255,0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ðŸ”§ COMPACT QUERY CARDS - HALF HEIGHT */
        .query-card {
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;  /* Smaller radius */
            transition: all 0.3s ease;
            margin-bottom: 1rem;  /* Tighter spacing */
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            height: 320px;  /* Fixed compact height */
        }

        .query-card.pending { border-left: 4px solid var(--warning); }
        .query-card.answered { border-left: 4px solid var(--success); }
        .query-card.closed { border-left: 4px solid var(--danger); opacity: 0.85; }

        .query-card:hover {
            box-shadow: var(--shadow-hover);
            border-color: rgba(26,86,219,0.2);
        }

        /* ðŸ”§ COMPACT USER AVATAR */
        .user-avatar {
            width: 40px; height: 40px;  /* Half size */
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 1rem;  /* Smaller font */
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            background: var(--primary);
        }

        /* ðŸ”§ COMPACT CONTENT */
        .card-body {
            padding: 1.25rem !important;  /* Half original padding */
        }

        .status-badge {
            padding: 6px 14px;  /* Smaller */
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .query-text {
            font-size: 0.95rem;  /* Smaller text */
            line-height: 1.5;    /* Tighter line height */
            color: #1f2937;
            font-weight: 500;
            max-height: 60px;    /* Limit height */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* ðŸ”§ COMPACT RESPONSE AREA */
        .response-area {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px dashed rgba(99,102,241,0.2);
            border-radius: 10px;
            min-height: 80px;  /* Half height */
            padding: 12px;
            transition: all 0.3s ease;
        }

        .response-area textarea {
            min-height: 60px;  /* Compact */
            font-size: 0.9rem;
        }

        .action-btn {
            padding: 8px 16px;  /* Smaller buttons */
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ðŸ”§ TIGHTER SPACING EVERYWHERE */
        .mb-4 { margin-bottom: 1rem !important; }
        .mb-5 { margin-bottom: 1.25rem !important; }
        .p-5 { padding: 2rem !important; }
        h5 { font-size: 1rem !important; }  /* Smaller headings */
        .h6 { font-size: 0.9rem !important; }

        .btn-lg { 
            padding: 8px 20px !important; 
            font-size: 0.9rem !important; 
        }

        .theme-toggle {
            width: 42px; height: 42px;  /* Smaller */
        }

        @media (max-width: 768px) {
            .admin-header { padding: 1.25rem 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .p-5 { padding: 1rem !important; }
            .query-card { height: 280px; }  /* Even smaller on mobile */
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Compact Header -->
        <div class="admin-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <h1 class="mb-1 fw-bold h4">  <!-- Smaller title -->
                        <i class="fas fa-comments me-2"></i>Student Queries
                    </h1>
                    <p class="mb-0 small opacity-90">Manage student questions 
                        <span class="badge status-pending px-2 py-1 ms-2">{{ pending_count }} pending</span>
                    </p>
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    <div class="stats-grid">
                        <div class="stats-card">
                            <div class="stats-number">{{ pending_count }}</div>
                            <div class="small fw-semibold opacity-90">Pending</div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-number">{{ queries|length if queries else 0 }}</div>
                            <div class="small fw-semibold opacity-90">Total</div>
                        </div>
                    </div>
                    
                    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </div>
                    
                    <a href="/admin_dashboard" class="btn btn-light btn-lg shadow">
                        <i class="fas fa-arrow-left me-1"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Compact Content -->
        <div class="p-5">
            {% if queries %}
            <div class="row g-3">  <!-- Tighter grid gap -->
                {% for query in queries %}
                <div class="col-lg-6 col-xl-4">
                    <div class="query-card h-100 {{ query.status }}">
                        <div class="card-body">
                            <!-- Compact Header -->
                            <div class="d-flex align-items-start justify-content-between mb-3">
                                <div class="d-flex align-items-center gap-2 flex-grow-1">
                                    <div class="user-avatar">
                                        {{ (query.username or query.user_name or 'U')[0].upper() }}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="mb-1 fw-bold">{{ query.username or query.user_name or 'Anonymous' }}</h5>
                                        <div class="d-flex flex-wrap gap-1 small">
                                            <span class="badge bg-primary-subtle text-primary px-2 py-1">{{ query.role|title }}</span>
                                            {% if query.user_id %}<span class="badge bg-secondary px-2 py-1">#{{ query.user_id }}</span>{% endif %}
                                            {% if query.email %}<span class="badge bg-light text-dark px-2 py-1" title="{{ query.email }}">{{ query.email[:12] }}...</span>{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <span class="status-badge status-{{ query.status }}">{{ query.status|title }}</span>
                            </div>

                            <!-- Compact Query -->
                            <div class="mb-3">
                                <div class="fw-bold mb-2 small text-primary d-flex align-items-center">
                                    <i class="fas fa-question-circle me-1"></i>Question
                                </div>
                                <div class="query-text">{{ query.query }}</div>
                            </div>

                            <!-- Compact Timestamp -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center text-muted small">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ query.created_at.strftime('%d %b, %I:%M %p') }}
                                    <span class="ms-2 px-2 py-1 bg-light rounded-pill">{{ query.created_at.strftime('%H:%M') }}</span>
                                </div>
                            </div>

                            <!-- Compact Response -->
                            {% if query.status == 'answered' and query.admin_response %}
                            <div class="alert alert-success border-0 mb-0 p-2 small rounded-2">
                                <div class="fw-bold mb-1 text-success small d-flex align-items-center">
                                    <i class="fas fa-check-circle me-1"></i>Response:
                                </div>
                                <div class="bg-light p-1 rounded">{{ query.admin_response }}</div>
                            </div>
                            {% elif query.status != 'closed' %}
                            <form method="POST" action="/api/admin_queries/{{ query.id }}/reply">
                                <div class="response-area mb-2">
                                    <textarea name="response" class="form-control border-0 p-2 small" rows="2" 
                                        placeholder="Type response..." required></textarea>
                                </div>
                                <div class="d-flex gap-1">
                                    <button type="submit" class="btn btn-reply action-btn flex-grow-1">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                    <button type="button" class="btn btn-close action-btn" onclick="closeQuery({{ query.id }})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <div class="text-center py-2">
                                <i class="fas fa-lock text-muted mb-1" style="font-size: 1.5rem;"></i>
                                <small class="text-muted d-block">Closed</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% else %}
            <div class="empty-state text-center py-8">
                <i class="fas fa-inbox mb-4" style="font-size: 4rem; opacity: 0.5;"></i>
                <h3 class="mb-3 fw-bold text-muted">No queries</h3>
                <p class="mb-4 opacity-75">Queries appear when students contact via chatbot</p>
                <a href="/admin_dashboard" class="btn btn-primary px-4">
                    <i class="fas fa-home me-2"></i>Dashboard
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- SAME SCRIPTS - UNCHANGED -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function closeQuery(queryId) {
            if(confirm('Close this query without replying?')) {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading me-1"></span>';
                btn.disabled = true;
                
                fetch(`/api/admin_queries/${query_id}/close`, { 
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) location.reload();
                    else {
                        alert('Error closing query');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                })
                .catch(() => {
                    alert('Error closing query');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
        });
    </script>
</body>
</html>
